////////////////// í™•ì¸í•™ê¸°
io.on('connection', (socket) => {
  console.log(`í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë¨: ${socket.id}`);

  // registerUser: í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ì† ì‹œ í˜¸ì¶œ
  socket.on('registerUser', async ({ walletAddr, nickname }) => {
    const normalizedWallet = walletAddr.toLowerCase();
    const isExistingUser = nameDB.has(normalizedWallet);

    userSockets.set(normalizedWallet, { socketId: socket.id, nickname });

   if (isExistingUser) {
      console.log(`ê¸°ì¡´ ì‚¬ìš©ìž ë“±ë¡: ${walletAddr} (${nickname})`);
      // ê¸°ì¡´ ì‚¬ìš©ìžëŠ” ê²€ì¦ìž ìŠ¹ì¸ ì—†ì´ ì¦‰ì‹œ ìž…ìž¥ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ë³´ëƒ„
      socket.emit('verificationCompleted', { approved: true });
   } else {
      // ì‹ ê·œ ì‚¬ìš©ìžëŠ” ê²€ì¦ìž ìŠ¹ì¸ ì ˆì°¨ ì‹œìž‘ (requestEntryì—ì„œ ì²˜ë¦¬)
      console.log(`ì‹ ê·œ ì‚¬ìš©ìž ë“±ë¡ ì‹œë„: ${walletAddr} (${nickname})`);
      // ì‹ ê·œ ì‚¬ìš©ìžëŠ” íŽ˜ì´ì§€ ì´ë™ ì—†ì´ ëŒ€ê¸°ìƒíƒœë¡œ ë†“ê³ , ì´ì œ requestEntryì—ì„œ ì§„í–‰
    }
  });
/////////////////////

  socket.on('registerValidator', ({ walletAddr, nickname }) => {
    const normalizedWallet = walletAddr.toLowerCase();
    validatorSockets.set(normalizedWallet, socket.id);
    console.log(`ðŸ”” ê²€ì¦ìž ë“±ë¡ë¨: ${walletAddr} (${nickname})`);
  });

  // ê¸°ì¡´ ì±„íŒ… ë¡œê·¸ ì „ì†¡
  const logs = loadChatLogs();
  socket.emit('chatLogs', logs);



// sendMessage ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
socket.on('sendMessage', ({ fromUser, message }) => {
  saveChatLog({ fromUser, message });
  const toSocketInfo = userSockets.get(fromUser.toLowerCase());
  if (toSocketInfo) io.to(toSocketInfo.socketId).emit('receiveMessage', { fromUser, message });
  socket.emit('receiveMessage', { fromUser, message });
});

